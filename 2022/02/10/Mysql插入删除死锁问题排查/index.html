<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">

<meta name="baidu-site-verification" content="code-AhZIkdDG9J" />
<meta name="google-site-verification" content="PeC9Clz1swOOWEProA3d9p39srZKONgJreLma19x0Cc" />
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="PeC9Clz1swOOWEProA3d9p39srZKONgJreLma19x0Cc">
  <meta name="baidu-site-verification" content="code-AhZIkdDG9J">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/purple/pace-theme-flash.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"skitii.vercel.app","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.10.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":false,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

  <meta name="description" content="搞懂Mysql插入删除是如何加锁的">
<meta property="og:type" content="article">
<meta property="og:title" content="Mysql插入删除死锁问题排查">
<meta property="og:url" content="https://skitii.vercel.app/2022/02/10/Mysql%E6%8F%92%E5%85%A5%E5%88%A0%E9%99%A4%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/index.html">
<meta property="og:site_name" content="Skitii">
<meta property="og:description" content="搞懂Mysql插入删除是如何加锁的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642074072500-6db92ae1-eaff-462f-af20-9f0fb579d2c0.png#clientId=u1d0a973d-d39c-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=207&id=uc5138bc1&margin=%5Bobject%20Object%5D&name=image.png&originHeight=207&originWidth=961&originalType=binary&ratio=1&rotation=0&showTitle=false&size=81604&status=done&style=none&taskId=u9feaf1b7-3944-4bda-b069-fb48f7151cd&title=&width=961">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642377267905-4e7f60c8-004b-4c62-9313-7e4a6d6738c5.png#clientId=ub48be365-8441-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=293&id=u060c8838&margin=%5Bobject%20Object%5D&name=image.png&originHeight=586&originWidth=1910&originalType=binary&ratio=1&rotation=0&showTitle=false&size=181462&status=done&style=none&taskId=u5f6f6851-c0a1-4849-a00b-ee7576e4bdb&title=&width=955">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642516633446-beceaa9f-6468-424d-b493-0dcf38284708.png#clientId=u56f5bcdf-874a-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=65&id=u9e1f885a&margin=%5Bobject%20Object%5D&name=image.png&originHeight=130&originWidth=1896&originalType=binary&ratio=1&rotation=0&showTitle=false&size=38765&status=done&style=none&taskId=u443b9767-dbf8-4aaf-9327-418f0eb25c4&title=&width=948">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642595958486-9b6c7bd9-d820-4732-88de-07943b535904.png#clientId=u8b19cdb6-bf92-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=348&id=u90cbff8d&margin=%5Bobject%20Object%5D&name=image.png&originHeight=348&originWidth=881&originalType=binary&ratio=1&rotation=0&showTitle=false&size=57322&status=done&style=none&taskId=ua0cb8125-6d19-43f7-b468-58cae125d82&title=&width=881">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642595985011-eea742e4-e772-4304-9191-370751e251c0.png#clientId=u8b19cdb6-bf92-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=171&id=u59c09004&margin=%5Bobject%20Object%5D&name=image.png&originHeight=171&originWidth=560&originalType=binary&ratio=1&rotation=0&showTitle=false&size=16731&status=done&style=none&taskId=u8ec56e12-27bd-4d24-b07f-767c578af60&title=&width=560">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642599276279-94f84360-1e7f-4148-8f2f-ae77161bb0b6.png#clientId=u23a50d9c-b0fd-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=112&id=ubb856f14&margin=%5Bobject%20Object%5D&name=image.png&originHeight=224&originWidth=1460&originalType=binary&ratio=1&rotation=0&showTitle=false&size=145102&status=done&style=none&taskId=ud9cda12f-cdd1-41cf-aff1-c5099cc89ce&title=&width=730">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642599253891-c90bea14-e1f4-459d-9090-b4996782ea4a.png#clientId=u23a50d9c-b0fd-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=170&id=u2e2ac32f&margin=%5Bobject%20Object%5D&name=image.png&originHeight=340&originWidth=1342&originalType=binary&ratio=1&rotation=0&showTitle=false&size=113383&status=done&style=none&taskId=ucf365b65-f865-4d54-bc6d-ed21d32a4df&title=&width=671">
<meta property="article:published_time" content="2022-02-10T11:58:16.000Z">
<meta property="article:modified_time" content="2022-07-27T02:51:59.873Z">
<meta property="article:author" content="Skitii">
<meta property="article:tag" content="Mysql">
<meta property="article:tag" content="问题排查">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642074072500-6db92ae1-eaff-462f-af20-9f0fb579d2c0.png#clientId=u1d0a973d-d39c-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=207&id=uc5138bc1&margin=%5Bobject%20Object%5D&name=image.png&originHeight=207&originWidth=961&originalType=binary&ratio=1&rotation=0&showTitle=false&size=81604&status=done&style=none&taskId=u9feaf1b7-3944-4bda-b069-fb48f7151cd&title=&width=961">


<link rel="canonical" href="https://skitii.vercel.app/2022/02/10/Mysql%E6%8F%92%E5%85%A5%E5%88%A0%E9%99%A4%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://skitii.vercel.app/2022/02/10/Mysql%E6%8F%92%E5%85%A5%E5%88%A0%E9%99%A4%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/","path":"2022/02/10/Mysql插入删除死锁问题排查/","title":"Mysql插入删除死锁问题排查"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Mysql插入删除死锁问题排查 | Skitii</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>

  <!--pjax：防止跳转页面音乐暂停-->
  <script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.js"></script>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Skitii</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">A Lazy Guy.</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>
	
      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E4%B8%9A%E5%8A%A1%E6%97%A5%E5%BF%97"><span class="nav-number">1.</span> <span class="nav-text">查看业务日志</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E6%AD%BB%E9%94%81%E6%97%A5%E5%BF%97"><span class="nav-number">2.</span> <span class="nav-text">查看死锁日志</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#insert%E5%8A%A0%E9%94%81"><span class="nav-number">3.</span> <span class="nav-text">insert加锁</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#insert%E5%8A%A0%E9%94%81%E8%BF%87%E7%A8%8B"><span class="nav-number">3.0.0.1.</span> <span class="nav-text">insert加锁过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA"><span class="nav-number">3.0.0.2.</span> <span class="nav-text">结论</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Delete%E5%8A%A0%E9%94%81"><span class="nav-number">4.</span> <span class="nav-text">Delete加锁</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A4%8D%E7%8E%B0"><span class="nav-number">5.</span> <span class="nav-text">复现</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%AD%BB%E9%94%81%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90"><span class="nav-number">6.</span> <span class="nav-text">死锁原因分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%8D%E7%8E%B01%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90%EF%BC%9A"><span class="nav-number">6.0.0.1.</span> <span class="nav-text">复现1原因分析：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%8D%E7%8E%B02%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90%EF%BC%9A"><span class="nav-number">6.0.0.2.</span> <span class="nav-text">复现2原因分析：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%9A%E5%8A%A1%E6%AD%BB%E9%94%81%E5%88%86%E6%9E%90"><span class="nav-number">6.0.0.3.</span> <span class="nav-text">业务死锁分析</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">7.</span> <span class="nav-text">参考</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Skitii"
      src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">Skitii</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">13</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="sidebar-button site-overview-item animated">
    <button><i class="fa fa-comment"></i>
      Contact
    </button>
  </div>



        </div>
      </div>

      <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=300 height=450 src="//music.163.com/outchain/player?type=0&id=7179117219&auto=1&height=430"></iframe>

    </div>
  
  </aside>
  
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://skitii.vercel.app/2022/02/10/Mysql%E6%8F%92%E5%85%A5%E5%88%A0%E9%99%A4%E6%AD%BB%E9%94%81%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Skitii">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Skitii">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Mysql插入删除死锁问题排查
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-02-10 19:58:16" itemprop="dateCreated datePublished" datetime="2022-02-10T19:58:16+08:00">2022-02-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-07-27 10:51:59" itemprop="dateModified" datetime="2022-07-27T10:51:59+08:00">2022-07-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Mysql/" itemprop="url" rel="index"><span itemprop="name">Mysql</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>7.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>7 分钟</span>
    </span>
</div>

            <div class="post-description">搞懂Mysql插入删除是如何加锁的</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <meta name="referrer" content="no-referrer" />
<span id="more"></span>

<h1 id="查看业务日志"><a href="#查看业务日志" class="headerlink" title="查看业务日志"></a>查看业务日志</h1><p><img src="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642074072500-6db92ae1-eaff-462f-af20-9f0fb579d2c0.png#clientId=u1d0a973d-d39c-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=207&id=uc5138bc1&margin=%5Bobject%20Object%5D&name=image.png&originHeight=207&originWidth=961&originalType=binary&ratio=1&rotation=0&showTitle=false&size=81604&status=done&style=none&taskId=u9feaf1b7-3944-4bda-b069-fb48f7151cd&title=&width=961" alt="image.png"></p>
<h1 id="查看死锁日志"><a href="#查看死锁日志" class="headerlink" title="查看死锁日志"></a>查看死锁日志</h1><p>show engine innodb status; （查询语句）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">------------------------</span><br><span class="line">LATEST DETECTED DEADLOCK</span><br><span class="line">------------------------</span><br><span class="line"><span class="number">2022</span><span class="number">-01</span><span class="number">-12</span> <span class="number">08</span>:<span class="number">24</span>:<span class="number">23</span> <span class="number">0x7f5a5cf75700</span></span><br><span class="line">*** (<span class="number">1</span>) TRANSACTION:</span><br><span class="line"><span class="comment">//事务A</span></span><br><span class="line">TRANSACTION <span class="number">9400396</span>, ACTIVE <span class="number">0</span> sec inserting</span><br><span class="line">mysql tables in use <span class="number">1</span>, locked <span class="number">1</span></span><br><span class="line">LOCK WAIT <span class="number">3</span> lock <span class="title function_">struct</span><span class="params">(s)</span>, heap size 1136, 2 row <span class="title function_">lock</span><span class="params">(s)</span>, undo <span class="built_in">log</span> entries 10</span><br><span class="line">MySQL thread id 2138935, OS thread handle 140026474653440, query id 58338774 10.21.17.247 liuchuangzhao update</span><br><span class="line">insert into <span class="title function_">t_device_online</span> <span class="params">(device_id, start_time, end_time,online_times)</span> <span class="title function_">values</span></span><br><span class="line"></span><br><span class="line">            <span class="params">(<span class="number">133</span>, <span class="number">1641975738</span>, <span class="number">1641975861</span>,<span class="number">1</span>)</span></span><br><span class="line">         ,</span><br><span class="line">            <span class="params">(<span class="number">137</span>, <span class="number">1641975727</span>, <span class="number">1641975861</span>,<span class="number">1</span>)</span></span><br><span class="line">         ,</span><br><span class="line">            <span class="params">(<span class="number">138</span>, <span class="number">1641975743</span>, null,<span class="number">1</span>)</span></span><br><span class="line">         ,</span><br><span class="line">            <span class="params">(<span class="number">144</span>, <span class="number">1641975726</span>, null,<span class="number">1</span>)</span></span><br><span class="line">         ,</span><br><span class="line">            <span class="params">(<span class="number">146</span>, <span class="number">1641975742</span>, null,<span class="number">1</span>)</span></span><br><span class="line">         ,</span><br><span class="line">            <span class="params">(<span class="number">147</span>, <span class="number">1641975728</span>, <span class="number">1641975862</span>,<span class="number">1</span>)</span></span><br><span class="line">         ,</span><br><span class="line">            <span class="params">(<span class="number">150</span>, <span class="number">1641975724</span>, null,<span class="number">1</span>)</span></span><br><span class="line">         ,</span><br><span class="line">            <span class="params">(<span class="number">152</span>, <span class="number">1641975746</span>, <span class="number">1641975861</span>,<span class="number">1</span>)</span></span><br><span class="line">         ,</span><br><span class="line">            <span class="params">(<span class="number">154</span>, <span class="number">1641975744</span>, null,<span class="number">1</span>)</span></span><br><span class="line">         ,</span><br><span class="line">            <span class="params">(<span class="number">28</span>, <span class="number">1641975737</span>, <span class="number">1641975861</span>,<span class="number">1</span>)</span></span><br><span class="line">         ,</span><br><span class="line">            <span class="params">(<span class="number">158</span>, <span class="number">1641975744</span>, null,<span class="number">1</span>)</span></span><br><span class="line">         ,</span><br><span class="line">            <span class="params">(<span class="number">32</span>, <span class="number">1641975736</span>, <span class="number">1641975862</span>,<span class="number">1</span>)</span></span><br><span class="line">         ,</span><br><span class="line">            <span class="params">(<span class="number">162</span>, <span class="number">1641975733</span>, null,<span class="number">1</span>)</span></span><br><span class="line">         ,</span><br><span class="line">            <span class="params">(<span class="number">36</span>, <span class="number">1641975736</span>, <span class="number">1641975861</span>,<span class="number">1</span>)</span></span><br><span class="line">         ,</span><br><span class="line">            <span class="params">(<span class="number">168</span>, <span class="number">1641975729</span>, null,<span class="number">1</span>)</span></span><br><span class="line">         ,</span><br><span class="line">            <span class="params">(<span class="number">40</span>, <span class="number">1641975732</span>, n</span></span><br><span class="line"><span class="params">*** (<span class="number">1</span>) WAITING FOR THIS LOCK TO BE GRANTED:</span></span><br><span class="line"><span class="params">RECORD LOCKS space id <span class="number">61</span> page no <span class="number">30559</span> n bits <span class="number">824</span> index device_id of table `ifp_remote_platform`.`t_device_online` trx id <span class="number">9400396</span> lock_mode X locks gap before rec insert intention waiting</span></span><br><span class="line"><span class="params">*** (<span class="number">2</span>) TRANSACTION:</span></span><br><span class="line"><span class="params"><span class="comment">//事务B</span></span></span><br><span class="line"><span class="params">TRANSACTION <span class="number">9400297</span>, ACTIVE <span class="number">1</span> sec fetching rows</span></span><br><span class="line"><span class="params">mysql tables in use <span class="number">1</span>, locked <span class="number">1</span></span></span><br><span class="line"><span class="params"><span class="number">72</span> lock <span class="keyword">struct</span>(s), heap size <span class="number">24784</span>, <span class="number">1748</span> row lock(s), undo <span class="built_in">log</span> entries <span class="number">5</span></span></span><br><span class="line"><span class="params">MySQL thread id <span class="number">2138649</span>, OS thread handle <span class="number">140026083497728</span>, query id <span class="number">58338328</span> <span class="number">10.21</span><span class="number">.17</span><span class="number">.247</span> liuchuangzhao updating</span></span><br><span class="line"><span class="params">delete from t_device_online where end_time is null</span></span><br><span class="line"><span class="params">            and device_id in</span></span><br><span class="line"><span class="params">             (</span></span><br><span class="line"><span class="params">                <span class="number">133</span></span></span><br><span class="line"><span class="params">             ,</span></span><br><span class="line"><span class="params">                <span class="number">137</span></span></span><br><span class="line"><span class="params">             ,</span></span><br><span class="line"><span class="params">                <span class="number">138</span></span></span><br><span class="line"><span class="params">             ,</span></span><br><span class="line"><span class="params">                <span class="number">144</span></span></span><br><span class="line"><span class="params">             ,</span></span><br><span class="line"><span class="params">                <span class="number">146</span></span></span><br><span class="line"><span class="params">             ,</span></span><br><span class="line"><span class="params">                <span class="number">147</span></span></span><br><span class="line"><span class="params">             ,</span></span><br><span class="line"><span class="params">                <span class="number">150</span></span></span><br><span class="line"><span class="params">             ,</span></span><br><span class="line"><span class="params">                <span class="number">152</span></span></span><br><span class="line"><span class="params">             ,</span></span><br><span class="line"><span class="params">                <span class="number">154</span></span></span><br><span class="line"><span class="params">             ,</span></span><br><span class="line"><span class="params">                <span class="number">28</span></span></span><br><span class="line"><span class="params">             ,</span></span><br><span class="line"><span class="params">                <span class="number">158</span></span></span><br><span class="line"><span class="params">             ,</span></span><br><span class="line"><span class="params">                <span class="number">32</span></span></span><br><span class="line"><span class="params">             ,</span></span><br><span class="line"><span class="params">                <span class="number">162</span></span></span><br><span class="line"><span class="params">             ,</span></span><br><span class="line"><span class="params">                <span class="number">36</span></span></span><br><span class="line"><span class="params">             ,</span></span><br><span class="line"><span class="params">                <span class="number">168</span></span></span><br><span class="line"><span class="params">             ,</span></span><br><span class="line"><span class="params">                <span class="number">40</span></span></span><br><span class="line"><span class="params">             ,</span></span><br><span class="line"><span class="params">                <span class="number">10536</span></span></span><br><span class="line"><span class="params">             ,</span></span><br><span class="line"><span class="params">                <span class="number">169</span></span></span><br><span class="line"><span class="params">             ,</span></span><br><span class="line"><span class="params">                <span class="number">170</span></span></span><br><span class="line"><span class="params">             ,</span></span><br><span class="line"><span class="params">                <span class="number">42</span></span></span><br><span class="line"><span class="params">             ,</span></span><br><span class="line"><span class="params">                <span class="number">10411</span></span></span><br><span class="line"><span class="params">             ,</span></span><br><span class="line"><span class="params">                <span class="number">171</span></span></span><br><span class="line"><span class="params">             ,</span></span><br><span class="line"><span class="params">                <span class="number">172</span></span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">*** (<span class="number">2</span>) HOLDS THE LOCK(S):</span></span><br><span class="line"><span class="params">RECORD LOCKS space id <span class="number">61</span> page no <span class="number">30559</span> n bits <span class="number">824</span> index device_id of table `ifp_remote_platform`.`t_device_online` trx id <span class="number">9400297</span> lock_mode X locks gap before rec</span></span><br><span class="line"><span class="params">*** (<span class="number">2</span>) WAITING FOR THIS LOCK TO BE GRANTED:</span></span><br><span class="line"><span class="params">RECORD LOCKS space id <span class="number">61</span> page no <span class="number">30545</span> n bits <span class="number">672</span> index device_id of table `ifp_remote_platform`.`t_device_online` trx id <span class="number">9400297</span> lock_mode X waiting</span></span><br><span class="line"><span class="params">*** WE ROLL BACK TRANSACTION (<span class="number">1</span>)</span></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>事务A（insert）</th>
<th>事务B（delete）</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td>​</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>持有行锁 824 index（X锁）</td>
</tr>
<tr>
<td>等行锁 824 index（X锁）</td>
<td></td>
</tr>
<tr>
<td></td>
<td>等行锁 672 index（X锁）</td>
</tr>
<tr>
<td>回滚</td>
<td></td>
</tr>
</tbody></table>
<p>从死锁日志上，可以，事务A并没有持有事务B所需要的资源啊，但是从现象上来看，事务A应该是持有了672的行锁。那我们就必须先了解insert的加锁过程。</p>
<h1 id="insert加锁"><a href="#insert加锁" class="headerlink" title="insert加锁"></a>insert加锁</h1><p><img src="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642377267905-4e7f60c8-004b-4c62-9313-7e4a6d6738c5.png#clientId=ub48be365-8441-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=293&id=u060c8838&margin=%5Bobject%20Object%5D&name=image.png&originHeight=586&originWidth=1910&originalType=binary&ratio=1&rotation=0&showTitle=false&size=181462&status=done&style=none&taskId=u5f6f6851-c0a1-4849-a00b-ee7576e4bdb&title=&width=955" alt="image.png"></p>
<h4 id="insert加锁过程"><a href="#insert加锁过程" class="headerlink" title="insert加锁过程"></a>insert加锁过程</h4><ol>
<li>先加插入意向Gap锁(insert intention gap lock)【如果别的事务已经有了这个间隙的锁Gap Lock，就无法加insert intention gap lock】</li>
<li>然后对插入的记录加索引记录锁（index-record lock）不会加gap锁，不影响其他insert的执行，除非他们插入的记录的索引值相同。</li>
<li>如果插入的记录索引值相同，则会出现duplicate-key error，就会对改索引加一个共享锁（shared lock）。但是如果有多个请求同时插入同一个索引值，这种情况可能会出现死锁。</li>
</ol>
<p>举个例子：</p>
<table>
<thead>
<tr>
<th>事务A</th>
<th>事务B</th>
<th>事务C</th>
</tr>
</thead>
<tbody><tr>
<td>START TRANSACTION;</td>
<td>​</td>
<td></td>
</tr>
<tr>
<td>​</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>INSERT INTO t1 VALUES(1);</td>
<td>START TRANSACTION;</td>
<td>START TRANSACTION;</td>
</tr>
<tr>
<td>获取到index-record lock(也是这个行记录的排查锁)</td>
<td>INSERT INTO t1 VALUES(1);</td>
<td>INSERT INTO t1 VALUES(1);</td>
</tr>
<tr>
<td>增加shared lock</td>
<td>遇到duplicate-key error</td>
<td>遇到duplicate-key error</td>
</tr>
<tr>
<td>​</td>
<td></td>
<td></td>
</tr>
<tr>
<td>等待shared lock</td>
<td>等待shared lock</td>
<td></td>
</tr>
<tr>
<td>ROLLBACK;</td>
<td>​</td>
<td></td>
</tr>
<tr>
<td>​</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>释放shared lock</td>
<td>获取到shared lock</td>
<td>获取到shared lock</td>
</tr>
<tr>
<td>释放排查锁</td>
<td>等待排查锁</td>
<td>等待排查锁</td>
</tr>
<tr>
<td></td>
<td>死锁</td>
<td>死锁</td>
</tr>
</tbody></table>
<p>事务B和C都获取到了shared lock，都在等待排他锁，但是排他锁和shared lock互斥，所以事务B和C都获取不到排他锁。（想要获取排他锁必须等对方释放shared lock，但是这是不可能的）<br><strong>还有一种情况也会产生死锁</strong></p>
<table>
<thead>
<tr>
<th>事务A</th>
<th>事务B</th>
<th>事务C</th>
</tr>
</thead>
<tbody><tr>
<td>START TRANSACTION;</td>
<td>​</td>
<td></td>
</tr>
<tr>
<td>​</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>delete from t1 where id &#x3D; 1;</td>
<td>START TRANSACTION;</td>
<td>START TRANSACTION;</td>
</tr>
<tr>
<td>获取到index-record lock(也是这个行记录的排查锁)</td>
<td>INSERT INTO t1 VALUES(1);</td>
<td>INSERT INTO t1 VALUES(1);</td>
</tr>
<tr>
<td>增加shared lock</td>
<td>遇到duplicate-key error</td>
<td>遇到duplicate-key error</td>
</tr>
<tr>
<td>​</td>
<td></td>
<td></td>
</tr>
<tr>
<td>等待shared lock</td>
<td>等待shared lock</td>
<td></td>
</tr>
<tr>
<td>commit;</td>
<td>​</td>
<td></td>
</tr>
<tr>
<td>​</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>释放shared lock</td>
<td>获取到shared lock</td>
<td>获取到shared lock</td>
</tr>
<tr>
<td>释放排查锁</td>
<td>等待排查锁</td>
<td>等待排查锁</td>
</tr>
<tr>
<td></td>
<td>死锁</td>
<td>死锁</td>
</tr>
</tbody></table>
<h4 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h4><p><strong>三个以上的并发插入，如果一个回滚了，可能会存在死锁（原因是出现</strong>duplicate-key error，其他事务都获取不到排他锁<strong>）</strong><br><strong>一个删除，两个并发插入，删除提交后也会造成死锁。</strong><br>​</p>
<h1 id="Delete加锁"><a href="#Delete加锁" class="headerlink" title="Delete加锁"></a>Delete加锁</h1><p><img src="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642516633446-beceaa9f-6468-424d-b493-0dcf38284708.png#clientId=u56f5bcdf-874a-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=65&id=u9e1f885a&margin=%5Bobject%20Object%5D&name=image.png&originHeight=130&originWidth=1896&originalType=binary&ratio=1&rotation=0&showTitle=false&size=38765&status=done&style=none&taskId=u443b9767-dbf8-4aaf-9327-418f0eb25c4&title=&width=948" alt="image.png"><br>delete加锁过程</p>
<ol>
<li>设置一个next-key的排他锁在每个搜索的行记录。（意味着除了占住行锁，还会占住间隙锁）</li>
<li>对于使用唯一索引搜索的情况只会对搜索的行加索引记录锁</li>
</ol>
<h1 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h1><p>复现方式1<br><img src="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642595958486-9b6c7bd9-d820-4732-88de-07943b535904.png#clientId=u8b19cdb6-bf92-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=348&id=u90cbff8d&margin=%5Bobject%20Object%5D&name=image.png&originHeight=348&originWidth=881&originalType=binary&ratio=1&rotation=0&showTitle=false&size=57322&status=done&style=none&taskId=ua0cb8125-6d19-43f7-b468-58cae125d82&title=&width=881" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642595985011-eea742e4-e772-4304-9191-370751e251c0.png#clientId=u8b19cdb6-bf92-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=171&id=u59c09004&margin=%5Bobject%20Object%5D&name=image.png&originHeight=171&originWidth=560&originalType=binary&ratio=1&rotation=0&showTitle=false&size=16731&status=done&style=none&taskId=u8ec56e12-27bd-4d24-b07f-767c578af60&title=&width=560" alt="image.png"><br>执行步骤：</p>
<table>
<thead>
<tr>
<th>事务A</th>
<th>事务B</th>
</tr>
</thead>
<tbody><tr>
<td>开始事务</td>
<td></td>
</tr>
<tr>
<td></td>
<td>开始事务</td>
</tr>
<tr>
<td>插入133</td>
<td></td>
</tr>
<tr>
<td></td>
<td>删除137</td>
</tr>
<tr>
<td>插入137</td>
<td></td>
</tr>
<tr>
<td></td>
<td>提交</td>
</tr>
<tr>
<td>死锁</td>
<td></td>
</tr>
</tbody></table>
<p>死锁日志</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">------------------------</span><br><span class="line">LATEST DETECTED DEADLOCK</span><br><span class="line">------------------------</span><br><span class="line"><span class="number">2022</span><span class="number">-01</span><span class="number">-19</span> <span class="number">12</span>:<span class="number">38</span>:<span class="number">16</span> <span class="number">0x7f59772d9700</span></span><br><span class="line">*** (<span class="number">1</span>) TRANSACTION:</span><br><span class="line"><span class="comment">//事务A</span></span><br><span class="line">TRANSACTION <span class="number">10649448</span>, ACTIVE <span class="number">136</span> sec inserting</span><br><span class="line">mysql tables in use <span class="number">1</span>, locked <span class="number">1</span></span><br><span class="line">LOCK WAIT <span class="number">3</span> lock <span class="title function_">struct</span><span class="params">(s)</span>, heap size 1136, 2 row <span class="title function_">lock</span><span class="params">(s)</span>, undo <span class="built_in">log</span> entries 2</span><br><span class="line">MySQL thread id 2419529, OS thread handle 140026471950080, query id 66144333 10.21.17.247 liuchuangzhao update</span><br><span class="line"><span class="comment">/* ApplicationName=DBeaver 21.0.0 - SQLEditor &lt;dev_with_high_pri.sql&gt; */</span> insert into <span class="title function_">t_device_online</span> <span class="params">(device_id, start_time, end_time,online_times)</span> <span class="title function_">values</span><span class="params">(<span class="number">137</span>, <span class="number">1641975727</span>, <span class="number">1641975861</span>,<span class="number">1</span>)</span></span><br><span class="line">*** <span class="params">(<span class="number">1</span>)</span> WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id 61 page no 30554 n bits 824 index device_id of table `ifp_remote_platform`.`t_device_online` trx id 10649448 lock_mode X locks gap before rec insert intention waiting</span><br><span class="line">*** <span class="params">(<span class="number">2</span>)</span> TRANSACTION:</span><br><span class="line"><span class="comment">//事务B</span></span><br><span class="line">TRANSACTION 10649665, ACTIVE 28 sec fetching rows</span><br><span class="line">mysql tables in use 1, locked 1</span><br><span class="line">35 lock <span class="title function_">struct</span><span class="params">(s)</span>, heap size 8400, 203 row <span class="title function_">lock</span><span class="params">(s)</span>, undo <span class="built_in">log</span> entries 100</span><br><span class="line">MySQL thread id 2419581, OS thread handle 140022228293376, query id 66144549 10.21.17.247 liuchuangzhao updating</span><br><span class="line"><span class="comment">/* ApplicationName=DBeaver 21.0.0 - SQLEditor &lt;Script-4.sql&gt; */</span> delete from t_device_online where device_id <span class="title function_">in</span> <span class="params">(<span class="number">133</span>)</span></span><br><span class="line">*** <span class="params">(<span class="number">2</span>)</span> HOLDS THE <span class="title function_">LOCK</span><span class="params">(S)</span>:</span><br><span class="line">RECORD LOCKS space id 61 page no 30554 n bits 824 index device_id of table `ifp_remote_platform`.`t_device_online` trx id 10649665 lock_mode X locks gap before rec</span><br><span class="line">*** <span class="params">(<span class="number">2</span>)</span> WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id 61 page no 30545 n bits 712 index device_id of table `ifp_remote_platform`.`t_device_online` trx id 10649665 lock_mode X waiting</span><br><span class="line">*** WE ROLL BACK <span class="title function_">TRANSACTION</span> <span class="params">(<span class="number">1</span>)</span></span><br></pre></td></tr></table></figure>

<hr>
<p>复现方式2<br><img src="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642599276279-94f84360-1e7f-4148-8f2f-ae77161bb0b6.png#clientId=u23a50d9c-b0fd-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=112&id=ubb856f14&margin=%5Bobject%20Object%5D&name=image.png&originHeight=224&originWidth=1460&originalType=binary&ratio=1&rotation=0&showTitle=false&size=145102&status=done&style=none&taskId=ud9cda12f-cdd1-41cf-aff1-c5099cc89ce&title=&width=730" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/21760570/1642599253891-c90bea14-e1f4-459d-9090-b4996782ea4a.png#clientId=u23a50d9c-b0fd-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=170&id=u2e2ac32f&margin=%5Bobject%20Object%5D&name=image.png&originHeight=340&originWidth=1342&originalType=binary&ratio=1&rotation=0&showTitle=false&size=113383&status=done&style=none&taskId=ucf365b65-f865-4d54-bc6d-ed21d32a4df&title=&width=671" alt="image.png"><br>执行过程</p>
<table>
<thead>
<tr>
<th>事务A</th>
<th>事务B</th>
</tr>
</thead>
<tbody><tr>
<td>开始事务</td>
<td></td>
</tr>
<tr>
<td></td>
<td>开始事务</td>
</tr>
<tr>
<td>插入137</td>
<td></td>
</tr>
<tr>
<td></td>
<td>删除137,133</td>
</tr>
<tr>
<td>插入133</td>
<td></td>
</tr>
<tr>
<td>死锁</td>
<td>​</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td>​</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>死锁日志</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">------------------------</span><br><span class="line">LATEST DETECTED DEADLOCK</span><br><span class="line">------------------------</span><br><span class="line"><span class="number">2022</span><span class="number">-01</span><span class="number">-19</span> <span class="number">12</span>:<span class="number">58</span>:<span class="number">59</span> <span class="number">0x7f5a74376700</span></span><br><span class="line">*** (<span class="number">1</span>) TRANSACTION:</span><br><span class="line"><span class="comment">//事务A</span></span><br><span class="line">TRANSACTION <span class="number">10652218</span>, ACTIVE <span class="number">4</span> sec starting index read</span><br><span class="line">mysql tables in use <span class="number">1</span>, locked <span class="number">1</span></span><br><span class="line">LOCK WAIT <span class="number">5</span> lock <span class="title function_">struct</span><span class="params">(s)</span>, heap size 1136, 5 row <span class="title function_">lock</span><span class="params">(s)</span>, undo <span class="built_in">log</span> entries 1</span><br><span class="line">MySQL thread id 2420044, OS thread handle 140022237755136, query id 66160375 10.21.17.247 liuchuangzhao updating</span><br><span class="line"><span class="comment">/* ApplicationName=DBeaver 21.0.0 - SQLEditor &lt;Script-4.sql&gt; */</span> delete from t_device_online where device_id <span class="title function_">in</span> <span class="params">(<span class="number">137</span>,<span class="number">133</span>)</span></span><br><span class="line">*** <span class="params">(<span class="number">1</span>)</span> WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id 61 page no 30554 n bits 824 index device_id of table `ifp_remote_platform`.`t_device_online` trx id 10652218 lock_mode X waiting</span><br><span class="line">*** <span class="params">(<span class="number">2</span>)</span> TRANSACTION:</span><br><span class="line"><span class="comment">//事务B</span></span><br><span class="line">TRANSACTION 10652205, ACTIVE 10 sec inserting</span><br><span class="line">mysql tables in use 1, locked 1</span><br><span class="line">3 lock <span class="title function_">struct</span><span class="params">(s)</span>, heap size 1136, 2 row <span class="title function_">lock</span><span class="params">(s)</span>, undo <span class="built_in">log</span> entries 2</span><br><span class="line">MySQL thread id 2420043, OS thread handle 140026473572096, query id 66160420 10.21.17.247 liuchuangzhao update</span><br><span class="line"><span class="comment">/* ApplicationName=DBeaver 21.0.0 - SQLEditor &lt;dev_with_high_pri.sql&gt; */</span> insert into <span class="title function_">t_device_online</span> <span class="params">(device_id, start_time, end_time,online_times)</span> <span class="title function_">values</span></span><br><span class="line"><span class="params">(<span class="number">133</span>, <span class="number">1641975727</span>, <span class="number">1641975861</span>,<span class="number">1</span>)</span></span><br><span class="line">*** <span class="params">(<span class="number">2</span>)</span> HOLDS THE <span class="title function_">LOCK</span><span class="params">(S)</span>:</span><br><span class="line">RECORD LOCKS space id 61 page no 30554 n bits 824 index device_id of table `ifp_remote_platform`.`t_device_online` trx id 10652205 lock_mode X locks rec but not gap</span><br><span class="line">*** <span class="params">(<span class="number">2</span>)</span> WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id 61 page no 30545 n bits 712 index device_id of table `ifp_remote_platform`.`t_device_online` trx id 10652205 lock_mode X locks gap before rec insert intention waiting</span><br><span class="line">*** WE ROLL BACK <span class="title function_">TRANSACTION</span> <span class="params">(<span class="number">2</span>)</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="死锁原因分析"><a href="#死锁原因分析" class="headerlink" title="死锁原因分析"></a>死锁原因分析</h1><p>虽然复现方式不一样，但是死锁日志是一样的。</p>
<h4 id="复现1原因分析："><a href="#复现1原因分析：" class="headerlink" title="复现1原因分析："></a>复现1原因分析：</h4><table>
<thead>
<tr>
<th>事务A</th>
<th>事务B</th>
</tr>
</thead>
<tbody><tr>
<td>开始事务</td>
<td></td>
</tr>
<tr>
<td></td>
<td>开始事务</td>
</tr>
<tr>
<td>插入133（插入index-recode-lock，意向排他锁，是一个隐式排他锁）</td>
<td></td>
</tr>
<tr>
<td></td>
<td>删除137（获取了137的行锁及周围间隙锁）</td>
</tr>
<tr>
<td>​</td>
<td></td>
</tr>
<tr>
<td>删除133</td>
<td></td>
</tr>
<tr>
<td>（发现133有隐式排他锁，就帮他加上记录锁。</td>
<td></td>
</tr>
<tr>
<td>等待133的排他锁，也就是133的行锁）</td>
<td></td>
</tr>
<tr>
<td>插入137（等待137周围的间隙锁）</td>
<td>​</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td>死锁</td>
<td></td>
</tr>
</tbody></table>
<h4 id="复现2原因分析："><a href="#复现2原因分析：" class="headerlink" title="复现2原因分析："></a>复现2原因分析：</h4><table>
<thead>
<tr>
<th>事务A</th>
<th>事务B</th>
</tr>
</thead>
<tbody><tr>
<td>开始事务</td>
<td></td>
</tr>
<tr>
<td></td>
<td>开始事务</td>
</tr>
<tr>
<td>插入137（插入index-recode-lock，意向排他锁，是一个隐式排他锁）</td>
<td></td>
</tr>
<tr>
<td></td>
<td>删除137,133 （获取了133的行锁，等待137的行锁）【这里可以说明删除会对in重排序，不然不会造成死锁】</td>
</tr>
<tr>
<td>插入133（等待133的行锁）</td>
<td></td>
</tr>
<tr>
<td>死锁</td>
<td>​</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td>​</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="业务死锁分析"><a href="#业务死锁分析" class="headerlink" title="业务死锁分析"></a>业务死锁分析</h4><ol>
<li>insert执行流程长，拿到了一些device_id</li>
<li>insert执行过程中，delete 对 in 里面的device_id进行排序，然后先于insert拿到后面要执行的device_id，但是需要等待insert已经获取的device_id。</li>
<li>insert要等delete已获取的device_id</li>
<li>就死锁了</li>
</ol>
<p><strong>待验证</strong><br>为什么delete会对in里面的device_id重排序？<br>我觉得是因为删除语句没有走索引，要全表扫描，mysql为了避免随机IO，就对in的device_id排序了。<br>为什么insert 不会？<br>insert默认是通过主键id去查找，然后插入都是很快的，所以不需要重排序。<br>​</p>
<p>复现1和复现2和最开始的死锁日志一致。<br>如果复现1还不能说明问题的话，复现2就很能说明问题了。只要insert的够慢，delete 先拿到insert接下来要删除的行锁，就会死锁。<br>​</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/varyall/article/details/80219459">https://blog.csdn.net/varyall/article/details/80219459</a> (insert加锁分析)<br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1900240">https://cloud.tencent.com/developer/article/1900240</a> (insert加锁分析)<br><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-locks-set.html">https://dev.mysql.com/doc/refman/5.7/en/innodb-locks-set.html</a> （mysql官网innodb加锁说明）<br><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/innodb-locks-set.html">https://www.docs4dev.com/docs/zh/mysql/5.7/reference/innodb-locks-set.html</a>(中文文档)</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Mysql/" rel="tag"># Mysql</a>
              <a href="/tags/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/" rel="tag"># 问题排查</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/02/09/%E7%AB%99%E5%9C%A8%E4%BD%BF%E7%94%A8%E8%A7%92%E5%BA%A6%E7%9C%8B%E7%BC%93%E5%AD%98/" rel="prev" title="站在使用角度看缓存">
                  <i class="fa fa-chevron-left"></i> 站在使用角度看缓存
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/02/10/OrderBy%E8%B8%A9%E5%9D%91%E4%B9%8B%E8%B7%AF/" rel="next" title="OrderBy踩坑之路">
                  OrderBy踩坑之路 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Skitii</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">32k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">29 分钟</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

<span id="sitetime"></span>
<script language=javascript>
	function siteTime(){
		window.setTimeout("siteTime()", 1000);
		var seconds = 1000;
		var minutes = seconds * 60;
		var hours = minutes * 60;
		var days = hours * 24;
		var years = days * 365;
		var today = new Date();
		var todayYear = today.getFullYear();
		var todayMonth = today.getMonth()+1;
		var todayDate = today.getDate();
		var todayHour = today.getHours();
		var todayMinute = today.getMinutes();
		var todaySecond = today.getSeconds();
		/* 
		Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
		year - 作为date对象的年份，为4位年份值
		month - 0-11之间的整数，做为date对象的月份
		day - 1-31之间的整数，做为date对象的天数
		hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
		minutes - 0-59之间的整数，做为date对象的分钟数
		seconds - 0-59之间的整数，做为date对象的秒数
		microseconds - 0-999之间的整数，做为date对象的毫秒数
        */
		var t1 = Date.UTC(2022,02,07,15,00,00); //北京时间2018-2-13 00:00:00
		var t2 = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond);
		var diff = t2-t1;
		var diffYears = Math.floor(diff/years);
		var diffDays = Math.floor((diff/days)-diffYears*365);
		var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours);
		var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes);
		var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds);
		document.getElementById("sitetime").innerHTML=" @Skitii 已安全提供服务 "+/*diffYears+" 年 "+*/diffDays+" 天 "+diffHours+" 小时 "+diffMinutes+" 分钟 "+diffSeconds+" 秒 💗";
	}
	siteTime();
</script>
    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.5.0/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="/js/pjax.js"></script>

  
<script class="next-config" data-name="chatra" type="application/json">{"enable":true,"async":true,"id":"H8oixnws8SKYQkjBz"}</script>
<script src="/js/third-party/chat/chatra.js"></script>
<script async src="https://call.chatra.io/chatra.js"></script>



  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>

  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"skitii/skitii","issue_term":"pathname","theme":"github-light","cdn":"https://utteranc.es/client.js"}</script>
<script src="/js/third-party/comments/utterances.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":1}});</script></body>
</html>
